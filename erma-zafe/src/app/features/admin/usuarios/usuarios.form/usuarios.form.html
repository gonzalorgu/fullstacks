<div class="usuario-form-container">
  <div class="form-header">
    <h3>{{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
    <button class="close-btn" (click)="onCancel()" type="button">✕</button>
  </div>

  @if (error) {
    <div class="alert alert-danger">
      {{ error }}
    </div>
  }

  <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">
    <div class="form-body">
      <!-- Nombre -->
      <div class="form-group">
        <label for="nombre">Nombre completo *</label>
        <input
          type="text"
          id="nombre"
          formControlName="nombre"
          class="form-control"
          [class.is-invalid]="f['nombre'].invalid && f['nombre'].touched"
          placeholder="Ej: Juan Pérez">
        @if (f['nombre'].invalid && f['nombre'].touched) {
          <div class="error-message">
            @if (f['nombre'].errors?.['required']) {
              <span>El nombre es requerido</span>
            }
            @if (f['nombre'].errors?.['minlength']) {
              <span>Mínimo 3 caracteres</span>
            }
          </div>
        }
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Correo electrónico *</label>
        <input
          type="email"
          id="email"
          formControlName="email"
          class="form-control"
          [class.is-invalid]="f['email'].invalid && f['email'].touched"
          placeholder="ejemplo@correo.com">
        @if (f['email'].invalid && f['email'].touched) {
          <div class="error-message">
            @if (f['email'].errors?.['required']) {
              <span>El email es requerido</span>
            }
            @if (f['email'].errors?.['email']) {
              <span>Email inválido</span>
            }
          </div>
        }
      </div>

      <!-- ✅ DNI (NUEVO) -->
      <div class="form-group">
        <label for="dni">DNI *</label>
        <input
          type="text"
          id="dni"
          formControlName="dni"
          class="form-control"
          [class.is-invalid]="f['dni'].invalid && f['dni'].touched"
          placeholder="12345678"
          maxlength="8">
        @if (f['dni'].invalid && f['dni'].touched) {
          <div class="error-message">
            @if (f['dni'].errors?.['required']) {
              <span>El DNI es requerido</span>
            }
            @if (f['dni'].errors?.['pattern']) {
              <span>El DNI debe tener exactamente 8 dígitos</span>
            }
            @if (f['dni'].errors?.['minlength'] || f['dni'].errors?.['maxlength']) {
              <span>El DNI debe tener exactamente 8 dígitos</span>
            }
          </div>
        }
      </div>

      <!-- Teléfono -->
      <div class="form-group">
        <label for="telefono">Teléfono (opcional)</label>
        <input
          type="tel"
          id="telefono"
          formControlName="telefono"
          class="form-control"
          [class.is-invalid]="f['telefono'].invalid && f['telefono'].touched"
          placeholder="987654321"
          maxlength="15">
        @if (f['telefono'].invalid && f['telefono'].touched) {
          <div class="error-message">
            @if (f['telefono'].errors?.['pattern']) {
              <span>Formato de teléfono inválido (9-15 dígitos)</span>
            }
          </div>
        }
      </div>

      <!-- ✅ FECHA DE NACIMIENTO (NUEVO) -->
      <div class="form-group">
        <label for="fechaNacimiento">Fecha de Nacimiento *</label>
        <input
          type="date"
          id="fechaNacimiento"
          formControlName="fechaNacimiento"
          class="form-control"
          [class.is-invalid]="f['fechaNacimiento'].invalid && f['fechaNacimiento'].touched">
        @if (f['fechaNacimiento'].invalid && f['fechaNacimiento'].touched) {
          <div class="error-message">
            @if (f['fechaNacimiento'].errors?.['required']) {
              <span>La fecha de nacimiento es requerida</span>
            }
          </div>
        }
      </div>

      <!-- ✅ DIRECCIÓN (NUEVO) -->
      <div class="form-group">
        <label for="direccion">Dirección *</label>
        <input
          type="text"
          id="direccion"
          formControlName="direccion"
          class="form-control"
          [class.is-invalid]="f['direccion'].invalid && f['direccion'].touched"
          placeholder="Av. Ejemplo 123, Lima">
        @if (f['direccion'].invalid && f['direccion'].touched) {
          <div class="error-message">
            @if (f['direccion'].errors?.['required']) {
              <span>La dirección es requerida</span>
            }
            @if (f['direccion'].errors?.['minlength']) {
              <span>La dirección debe tener al menos 5 caracteres</span>
            }
          </div>
        }
      </div>

      <!-- Rol -->
      <div class="form-group">
        <label for="rol">Rol *</label>
        <select id="rol" formControlName="role" class="form-control">
          @for (rol of roles; track rol.value) {
            <option [value]="rol.value">{{ rol.label }}</option>
          }
        </select>
      </div>

      <!-- Estado activo -->
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="isActive">
          <span>Usuario activo</span>
        </label>
        <small class="help-text">
          Los usuarios inactivos no podrán acceder al sistema
        </small>
      </div>

      <!-- Password (solo en creación) -->
      @if (!isEditMode) {
        <div class="form-group">
          <label for="password">Contraseña *</label>
          <input
            type="password"
            id="password"
            formControlName="password"
            class="form-control"
            [class.is-invalid]="f['password'].invalid && f['password'].touched"
            placeholder="Mínimo 8 caracteres">
          @if (f['password'].invalid && f['password'].touched) {
            <div class="error-message">
              @if (f['password'].errors?.['required']) {
                <span>La contraseña es requerida</span>
              }
              @if (f['password'].errors?.['minlength']) {
                <span>Mínimo 8 caracteres</span>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Botones de acción -->
    <div class="form-footer">
      <button type="button" (click)="onCancel()" class="btn btn-secondary" [disabled]="cargando">
        Cancelar
      </button>
      <button type="submit" [disabled]="!usuarioForm.valid || cargando" class="btn btn-primary">
        @if (cargando) {
          <span>Guardando...</span>
        } @else {
          <span>{{ isEditMode ? 'Actualizar' : 'Crear Usuario' }}</span>
        }
      </button>
    </div>
  </form>
</div>
